env:
  nsxManager:
    ip: '${NSX_MANAGER_IP}'
    username: 'admin'
    password: '${NSX_MANAGER_PASS}'
  nsxController:
    - ip: '${NSX_CONTROLLER_01_IP}'
      username: 'admin'    
      password: '${NSX_CONTROLLER_01_PASS}'
      secret: 'VMware1!'
  nsxEdge:
    - ip: '${NSX_EDGE_01_IP}'
      username: 'admin'    
      password: '${NSX_EDGE_01_PASS}'
    - ip: '${NSX_EDGE_02_IP}'
      username: 'admin'    
      password: '${NSX_EDGE_02_PASS}'
      
# action: create,update,delete
    
tasks:
  - module: 'LogicalSwitch'
    action: 'create'
    data:
      display_name: 'k8s-mgmt'
      transport_zone_id: 'OverlayTZ'
  - module: 'LogicalSwitch'
    action: 'create'
    data:
      display_name: 'k8s-transport'
      transport_zone_id: 'OverlayTZ'

  - module: 'LogicalSwitch'
    action: 'create'
    data:
      display_name: 'ExternalLS'
      transport_zone_id: 'VlanTZ'
      vlan: '0'

  - module: 'T0'
    action: 'create'
    data:
      display_name: 'T0'
      edge_cluster_id: 'EdgeCluster1'
      failover_mode: 'PREEMPTIVE'
      high_availability_mode: 'ACTIVE_STANDBY'
      router_type: 'TIER0'
      
  - module: 'T0'
    action: 'update'
    data:
      display_name: 'T0'
      create_uplink:
        ls: 'ExternalLS'
        display_name: 'Uplink1'
        ip_address: '192.168.240.3'
        prefix_length: '24'
        edge_node: 'nsxedge-01a'

  - module: 'T0'
    action: 'update'
    data:
      display_name: 'T0'
      create_uplink:
        ls: 'ExternalLS'
        display_name: 'Uplink2'
        ip_address: '192.168.240.4'
        prefix_length: '24'
        edge_node: 'nsxedge-02a'
        
  - module: 'T0'
    action: 'update'
    data:
      target: 'bgp'
      display_name: 'T0'
      as_num: 100
      ecmp: False
      enabled: True
      graceful_restart: False

  - module: 'T0'
    action: 'update'
    data:
      target: 'redistribution'
      display_name: 'T0'      
      bgp_enabled: True

  - module: 'T0'
    action: 'create'
    data:
      target: 'redistribution_rule'
      display_name: 'T0'
      rule_name: 'Rest k8s route'
      destination: "BGP"
      sources:
        # - 'NSX_CONNECTED'
        - 'NSX_STATIC'
        - 'TIER0_NAT'
        # - 'TIER1_NAT'
        - 'TIER1_LB_VIP'
        # - 'TIER1_LB_SNAT'
        # - "STATIC"

  - module: 'T0'
    action: 'create'
    data:
      display_name: 'T0'      
      target: 'bgp_neighbor'
      neighbor_address: '192.168.240.1'
      remote_as_num: '200'

  - module: 'NAT'
    action: 'create'
    data:
      LR: 'T0'
      action: 'NO_SNAT'
      display_name: 'nosnat_to_k8snodes'
      match_source_network: '172.16.128.0/17'
      match_destination_network: '192.168.120.0/24'
      translated_network: ''
      rule_priority: 800
      
  - module: 'NAT'
    action: 'create'
    data:
      LR: 'T0'
      action: 'NO_SNAT'
      display_name: 'nosnat_to_dns'
      match_source_network: '172.16.128.0/17'
      match_destination_network: '192.168.110.0/24'
      translated_network: ''
      rule_priority: 800
    
  - module: 'IPPool'
    action: 'create'
    data:
      display_name: 'k8s-ippool'
      subnets:
        - allocation_ranges:
            - start: '172.16.100.1'
              end: '172.16.100.200'
          cidr: '172.16.100.0/24'

  - module: 'IPBlock'
    action: 'create'
    data:
      display_name: 'k8s-ipblock'      
      cidr: '172.16.128.0/17'
          
  - module: 'DFWSection'
    action: 'create'
    data:
      display_name: 'AdminBottom'
      section_type: 'LAYER3'
      stateful: 'True'
      tags:
        - scope: 'ncp/fw_sect_marker'
          tag: 'bottom'

  - module: 'DFWSection'
    action: 'create'
    data:
      display_name: 'AdminMiddle'
      section_type: 'LAYER3'
      stateful: 'True'

  - module: 'DFWSection'
    action: 'create'
    data:
      display_name: 'AdminTop'
      section_type: 'LAYER3'
      stateful: 'True'
      tags:
        - scope: 'ncp/fw_sect_marker'
          tag: 'top'
          
